{"Data":{"Forms":[{"Constructor":"CustomControlDesignPH","Config":{"Controls":[{"Constructor":"CustomControlObjectPH","Config":{"_Css":"control","ConfigCode":"m_MsgPanel_Config.User = config.User\u000am_MsgPanel_Config.Peer = config.Peer;\u000a\u000aif (config.Peer.Type == 0)\u000a{\u000a    m_MsgPanel_Config.Operations = [{\u000a        Text: \u0022引用\u0022\u002c\u000a        Command: \u0022Quote\u0022\u000a    }];\u000a}\u000aelse\u000a{\u000a    m_MsgPanel_Config.Operations = [{\u000a        Text: \u0022加为好友\u0022\u002c\u000a        Command: \u0022AddFriend\u0022\u000a    }\u002c\u000a    {\u000a        Text: \u0022私聊\u0022\u002c\u000a        Command: \u0022Chat\u0022\u000a    }\u002c\u000a    {\u000a        Text: \u0022引用\u0022\u002c\u000a        Command: \u0022Quote\u0022\u000a    }];\u000a}","InitCode":"","ClassName":"MsgPanel","Count":0,"Left":0,"Top":25,"Width":490,"Height":334,"Name":"m_MsgPanel","Text":"","AnchorStyle":15}},{"Constructor":"CustomControlObjectPH","Config":{"_Css":"control","ConfigCode":"m_MsgEditor_Config.BorderWidth = 1;\u000am_MsgEditor_Config.Css = \u0022richEditor\u0022;","InitCode":"","ClassName":"MsgEditor","Count":0,"Left":0,"Top":364,"Width":490,"Height":97,"Name":"m_MsgEditor","Text":"","AnchorStyle":13}},{"Constructor":"ButtonPH","Config":{"_Css":"button_default","OnClickCode":"if (m_MsgEditor.GetValue().length \u003e 4096)\u000a{\u000a    alert(\u0022消息不能超过4000个字符！\u0022);\u000a    return;\u000a}\u000a\u000aif (IsEmpty(m_MsgEditor.GetValue()))\u000a{\u000a    alert(\u0022消息不能为空！\u0022);\u000a    return;\u000a}\u000a\u000avar data = {\u000a    Action: \u0022NewMessage\u0022\u002c\u000a    Sender: m_User.Name\u002c\u000a    Receiver: m_Peer.Name\u000a};\u000a\u000adata.Content = TranslateMessage(m_MsgEditor.GetValue()\u002c data);\u000a\u000avar temp = m_MsgPanel.CreateMessage(data.Content\u002c data);\u000am_MsgEditor.SetValue(\u0022 \u0022);\u000a\u000afunction Send_Error(ex)\u000a{\u000a    alert(ex);\u000a}\u000a\u000afunction Send_Callback(data)\u000a{\u000a    var message = data;\u000a    m_MsgPanel.AddMessage(message\u002c temp);\u000a}\u000a\u000aCore.SendCommand(Send_Callback\u002c Send_Error\u002c IMCore.Utility.RenderJson(data)\u002c \u0022Core.Web WebIM\u0022\u002c false);","InitCode":"","Count":0,"Left":408,"Top":466,"Width":81,"Height":26,"Name":"m_BtnSend","Text":"发送","AnchorStyle":12}},{"Constructor":"ToolbarPH","Config":{"_Css":"toolbar","OnCommandCode":"if (command == \u0022AddFriend\u0022)\u000a{\u000a    IMCore.Session.GetGlobal(\u0022SingletonForm\u0022).ShowAddFriendForm(m_Peer.Name);\u000a}\u000aelse if (command == \u0022SendFile\u0022)\u000a{\u000a    if (ClientMode)\u000a    {\u000a        var file = window.external.OpenFile(\u0022\u0022);\u000a        if (file != \u0022\u0022)\u000a        {\u000a            m_MsgPanel.UploadFile(file\u002c\u000a            function(path)\u000a            {\u000a                if (path == \u0022\u0022) return;\u000a                var html = m_MsgEditor.CreateFileHtml([path]);\u000a                Send(html);\u000a            });\u000a        }\u000a    }\u000a    else\u000a    {\u000a        var tag = {};\u000a        tag.AfterUpload = function(path)\u000a        {\u000a            form.Close();\u000a            var html = m_MsgEditor.CreateFileHtml([path]);\u000a            Send(html);\u000a        }\u000a\u000a        var form = IMCore.CreateWindow({\u000a            Left: 0\u002c\u000a            Top: 0\u002c\u000a            Width: 250\u002c\u000a            Height: 100\u002c\u000a            Title: {\u000a                InnerHTML: \u0022请选择要添加的文件...\u0022\u000a            }\u002c\u000a            Resizable: false\u002c\u000a            HasMinButton: false\u002c\u000a            HasMaxButton: false\u000a        });\u000a\u000a        form.SetTag(tag);\u000a        form.ShowDialog(CurrentWindow\u002c \u0022center\u0022\u002c 0\u002c -10\u002c true\u002c null);\u000a        form.Load(IMCore.GetPageUrl(\u0022Upload.aspx\u0022)\u002c null);\u000a    }\u000a}\u000aelse if (command == \u0022SendImage\u0022)\u000a{\u000a    if (ClientMode)\u000a    {\u000a        var file = window.external.OpenFile(\u0022图片文件|*.png;*.gif;*.jpg;*.jpeg;*.bmp;*.jpe\u0022);\u000a        if (file != \u0022\u0022)\u000a        {\u000a            var html = String.format(\u0022\u003cimg src=\u005c\u0022file:///{0}\u005c\u0022/\u003e\u0022\u002c file);\u000a            m_MsgEditor.Append(html);\u000a        }\u000a    }\u000a    else\u000a    {\u000a        var tag = {};\u000a        tag.AfterUpload = function(path)\u000a        {\u000a            form.Close();\u000a            var imgHTML = String.format(\u0022\u003cimg src=\u005c\u0022{1}?FileName={0}\u005c\u0022/\u003e\u0022\u002c escape(path)\u002c IMCore.GetPageUrl(\u0022download.aspx\u0022));\u000a            m_MsgEditor.Append(imgHTML);\u000a        }\u000a\u000a        var form = IMCore.CreateWindow({\u000a            Left: 0\u002c\u000a            Top: 0\u002c\u000a            Width: 250\u002c\u000a            Height: 100\u002c\u000a            Title: {\u000a                InnerHTML: \u0022请选择你要添加的图片...\u0022\u000a            }\u002c\u000a            Resizable: false\u002c\u000a            HasMinButton: false\u002c\u000a            HasMaxButton: false\u000a        });\u000a\u000a        form.SetTag(tag);\u000a        form.ShowDialog(CurrentWindow\u002c \u0022center\u0022\u002c 0\u002c -10\u002c true\u002c null);\u000a        form.Load(IMCore.GetPageUrl(\u0022Upload.aspx\u0022)\u002c null);\u000a    }\u000a}\u000aelse if (command == \u0022GradScreen\u0022)\u000a{\u000a    if (ClientMode)\u000a    {\u000a        var file = window.external.GradScreen();\u000a        if (file != \u0022\u0022)\u000a        {\u000a            var html = String.format(\u0022\u003cimg src=\u005c\u0022file:///{0}\u005c\u0022/\u003e\u0022\u002c file);\u000a            m_MsgEditor.Append(html);\u000a        }\u000a    }\u000a}\u000aelse if (command == \u0022MsgRecord\u0022)\u000a{\u000a    IMCore.Session.GetGlobal(\u0022SingletonForm\u0022).ShowMsgHistoryForm(m_Peer);\u000a}","InitCode":"if (!config.User.IsTemp \u0026\u0026 !config.Peer.IsTemp)\u000a{\u000a    m_Toolbar.SetButtonVisible(4\u002c false);\u000a    IMCore.Session.GetGlobal(\u0022FriendsInfoCache\u0022).GetFriends(\u000a    function()\u000a    {\u000a        var fi = IMCore.Session.GetGlobal(\u0022FriendsInfoCache\u0022).GetFriendInfo(config.Peer.Name);\u000a        m_Toolbar.SetButtonVisible(4\u002c config.Peer.Type == 0 \u0026\u0026 fi == null);\u000a    });\u000a}\u000a\u000a m_Toolbar.SetButtonVisible(3\u002c !config.User.IsTemp \u0026\u0026 !config.Peer.IsTemp);\u000a m_Toolbar.SetButtonVisible(4\u002c !config.User.IsTemp \u0026\u0026 !config.Peer.IsTemp);","Controls":[],"_Items":[{"Text":"发送文件","Css":"Image22_MoveTo","Command":"SendFile"},{"Text":"发送图片","Css":"Image22_Picture","Command":"SendImage"},{"Text":"截图","Css":"Image22_Picture","Command":"GradScreen"},{"Text":"消息历史","Css":"Image22_MessageRecord","Command":"MsgRecord"},{"Text":"加为好友","Css":"Image22_Add","Command":"AddFriend"}],"Count":0,"Left":0,"Top":0,"Width":490,"Height":24,"Name":"m_Toolbar","Text":"","AnchorStyle":7}}],"MemberCode":"var split = Controls.CreateHorizSplit(m_MsgPanel\u002c m_MsgEditor\u002c false);\u000a\u000avar m_User = config.User\u000avar m_Peer = config.Peer;\u000a\u000avar m_From = new Date(0);\u000avar m_ErrorCount = 0;\u000avar m_RecordMaxTime = null;\u000a\u000am_MsgPanel.OnCommand.Attach(\u000afunction(cmd\u002c msg)\u000a{\u000a    if (cmd == \u0022AddFriend\u0022)\u000a    {\u000a        if (msg.Sender.ID != IMCore.Session.GetUserInfo().ID)\u000a        {\u000a            IMCore.Session.GetGlobal(\u0022SingletonForm\u0022).ShowAddFriendForm(msg.Sender.Name);\u000a        }\u000a    }\u000a    else if (cmd == \u0022Chat\u0022)\u000a    {\u000a        if (msg.Sender.ID != IMCore.Session.GetUserInfo().ID)\u000a        {\u000a            IMCore.Session.GetGlobal(\u0022ChatService\u0022).Open(msg.Sender.Name);\u000a        }\u000a    }\u000a    else if (cmd == \u0022Quote\u0022)\u000a    {\u000a        msg.Content = msg.Content.replace(/\u005cx5BFILE\u005cx3A[^\u005ct\u005cn\u005cr\u005cf\u005cv\u005cx5B\u005cx5D]+\u005cx5D/ig\u002c\u000a        function(val)\u000a        {\u000a            var file = val.substr(6\u002c val.length - 7);\u000a            return String.format(\u000a            FileHtmlFormat\u002c IMCore.Path.GetFileName(unescape(file))\u002c file);\u000a        });\u000a\u000a        msg.Content = msg.Content.replace(/\u005cx5BA\u005cx3A[^\u005ct\u005cn\u005cr\u005cf\u005cv\u005cx5B\u005cx5D]+\u005cx5D/ig\u002c\u000a        function(val)\u000a        {\u000a            var file = val.substr(3\u002c val.length - 4);\u000a            return String.format(\u0022\u003ca target=\u0027_blank\u0027 href=\u0027{0}\u0027 onclick=\u0027return window.OpenLink(this.href);\u0027\u003e\u0022\u002c unescape(file));\u000a        });\u000a\u000a        msg.Content = msg.Content.replace(/\u005cx5B\u005cx2FA\u005cx5D/ig\u002c\u000a        function(val)\u000a        {\u000a            return \u0022\u003c/a\u003e\u0022;\u000a        });\u000a\u000a        var html = String.format(MessageFormat\u002c IMCore.Utility.IsNull(msg.Sender.Nickname\u002c msg.Sender.Name)\u002c DateToString(msg.CreatedTime == undefined ? new Date() : msg.CreatedTime)\u002c msg.Content);\u000a        html = String.format(\u0022\u003cdiv class=\u0027message_quote\u0027\u003e\u003cdiv class=\u0027message\u0027\u003e{0}\u003c/div\u003e\u003c/div\u003e\u0022\u002c html);\u000a        m_MsgEditor.Append(html);\u000a    }\u000a});\u000a\u000am_MsgEditor.OnKeyDown.Attach(function(evt)\u000a{\u000a    if (evt.keyCode == 13 \u0026\u0026 !evt.ctrlKey \u0026\u0026 !evt.altKey \u0026\u0026 !evt.shiftKey)\u000a    {\u000a        IMCore.Utility.PreventDefault(evt);\u000a        setTimeout(m_BtnSend.Click\u002c 1);\u000a    }\u000a});\u000a\u000afunction MsgSort(msg1\u002c msg2)\u000a{\u000a    if (msg1.CreatedTime \u003e msg2.CreatedTime) return 1;\u000a    if (msg1.CreatedTime \u003c msg2.CreatedTime) return - 1;\u000a    return 0;\u000a}\u000a\u000afunction Send(content)\u000a{\u000a    var data = {\u000a        Action: \u0022NewMessage\u0022\u002c\u000a        Sender: m_User.Name\u002c\u000a        Receiver: m_Peer.Name\u000a    };\u000a\u000a    data.Content = TranslateMessage(content\u002c data);\u000a\u000a    var temp = m_MsgPanel.CreateMessage(data.Content);\u000a    m_MsgEditor.SetValue(\u0022 \u0022);\u000a\u000a    function Send_Error(ex)\u000a    {\u000a        alert(ex);\u000a    }\u000a\u000a    function Send_Callback(data)\u000a    {\u000a        var message = data;\u000a        m_MsgPanel.AddMessage(message\u002c temp);\u000a    }\u000a\u000a    IMCore.SendCommand(Send_Callback\u002c Send_Error\u002c IMCore.Utility.RenderJson(data)\u002c \u0022Core.Web WebIM\u0022\u002c false);\u000a}\u000a\u000aThis.AddMessage = function(msg)\u000a{\u000a    m_MsgPanel.AddMessage(msg);\u000a    CurrentWindow.Notify();\u000a}\u000a\u000am_Toolbar.SetButtonVisible(2\u002c ClientMode);","CustomConfig":"config.Css = \u0022MainWnd\u0022;","BaseName":"Control","GlobalCode":"Module.ChatPanel = ChatPanel;","Count":9,"Left":33,"Top":26,"Width":490,"Height":493,"Name":"ChatPanel","Text":"","AnchorStyle":0}},{"Constructor":"CustomControlDesignPH","Config":{"Controls":[],"MemberCode":"var msg_css = IMCore.Utility.IsNull(config.MessageCss\u002c \u0022message\u0022);\u000a\u000aThis.OnCommand = new IMCore.Delegate();\u000a\u000aThis.Clear = function()\u000a{\u000a    This.GetDocument().body.innerHTML = \u0022\u0022;\u000a}\u000a\u000aThis.CreateMessage = function(content)\u000a{\u000a    content = content.replace(/\u003cimg\u005cs[^\u003c\u003e]*\u003e/ig\u002c\u000a    function(val)\u000a    {\u000a        return String.format(\u0022\u003cimg src=\u0027{0}\u0027/\u003e\u0022\u002c IMCore.GetUrl(\u0022Themes/Default/WebIM/loading_img.gif\u0022));\u000a    });\u000a\u000a    content = content.replace(/\u005cx5BFILE\u005cx3A\u005cs*\u005c{Accessory\u005cs+type=\u005c\u0022file\u005c\u0022\u005cs+src=\u005c\u0022([^\u005ct\u005cn\u005cr\u005cf\u005cv\u005cx5B\u005cx5D]+)\u005c\u0022\u005c}\u005cx5D/ig\u002c\u000a    function(val\u002c file)\u000a    {\u000a        return String.format(\u0022\u003cdiv class=\u0027div_filename\u0027\u003e\u003cimg src=\u0027{0}\u0027/\u003e\u003c/div\u003e\u0022\u002c IMCore.GetUrl(\u0022Themes/Default/WebIM/loading_file.gif\u0022)\u002c file);\u000a    });\u000a\u000a    var msgDiv = This.GetDocument().createElement(\u0022DIV\u0022);\u000a    msgDiv.className = msg_css;\u000a    msgDiv.innerHTML = String.format(\u0022\u003cdiv class=\u0027messageTitle\u0027\u003e\u0022 + \u0022\u003cspan class=\u0027sender\u0027\u003e{0}\u003c/span\u003e\u0022 + \u0022\u003cspan class=\u0027time\u0027\u003e{1}\u003c/span\u003e\u0022 + \u0022\u003cdiv class=\u0027operationContainer\u0027 style=\u0027display:none;\u0027\u003e\u0022 + \u0022\u003c/div\u003e\u0022 + \u0022\u003c/div\u003e\u0022 + \u0022\u003cdiv class=\u0027messageContent\u0027\u003e{2}\u0022 + \u0022\u003c/div\u003e\u0022\u002c m_User.Nickname\u002c DateToString(new Date())\u002c content);\u000a    This.GetDocument().body.appendChild(msgDiv);\u000a    This.GetDocument().body.scrollTop = This.GetDocument().body.scrollHeight;\u000a    return msgDiv;\u000a}\u000a\u000aThis.AddMessage = function(msg\u002c temp\u002c custom)\u000a{\u000a    msg.Content = msg.Content.replace(/\u005cx5BFILE\u005cx3A[^\u005ct\u005cn\u005cr\u005cf\u005cv\u005cx5B\u005cx5D]+\u005cx5D/ig\u002c\u000a    function(val)\u000a    {\u000a        var file = val.substr(6\u002c val.length - 7);\u000a        return String.format(\u000a        FileHtmlFormat\u002c IMCore.Path.GetFileName(unescape(file))\u002c file);\u000a    });\u000a\u000a    msg.Content = msg.Content.replace(/\u005cx5BA\u005cx3A[^\u005ct\u005cn\u005cr\u005cf\u005cv\u005cx5B\u005cx5D]+\u005cx5D/ig\u002c\u000a    function(val)\u000a    {\u000a        var file = val.substr(3\u002c val.length - 4);\u000a        return String.format(\u0022\u003ca target=\u0027_blank\u0027 href=\u0027{0}\u0027 onclick=\u0027return window.OpenLink(this.href);\u0027\u003e\u0022\u002c unescape(file));\u000a    });\u000a\u000a    msg.Content = msg.Content.replace(/\u005cx5B\u005cx2FA\u005cx5D/ig\u002c\u000a    function(val)\u000a    {\u000a        return \u0022\u003c/a\u003e\u0022;\u000a    });\u000a\u000a    var msgDiv = This.GetDocument().createElement(\u0022DIV\u0022);\u000a    msgDiv.className = msg_css;\u000a    msgDiv.innerHTML = String.format(MessageFormat\u002c IMCore.Utility.IsNull(msg.Sender.Nickname\u002c msg.Sender.Name)\u002c DateToString(msg.CreatedTime == undefined ? new Date() : msg.CreatedTime)\u002c msg.Content\u002c Module.GetResourceUrl(\u0022WebIM/user.png\u0022));\u000a\u000a    if (config.Operations != undefined)\u000a    {\u000a        var opeContainer = msgDiv.firstChild.childNodes[2];\u000a        opeContainer.style.display = \u0022none\u0022;\u000a\u000a        msgDiv.onmousemove = function()\u000a        {\u000a            opeContainer.style.display = \u0022inline\u0022;\u000a        }\u000a\u000a        msgDiv.onmouseout = function()\u000a        {\u000a            opeContainer.style.display = \u0022none\u0022;\u000a        }\u000a\u000a        var opeHtml = \u0022\u0022;\u000a        for (var i in config.Operations)\u000a        {\u000a            var opeA = This.GetDocument().createElement(\u0022A\u0022);\u000a            opeA.innerHTML = config.Operations[i].Text;\u000a            opeContainer.appendChild(opeA);\u000a\u000a            (function(command\u002c msg\u002c opeA)\u000a            {\u000a                opeA.onclick = function()\u000a                {\u000a                    This.OnCommand.Call(command\u002c msg);\u000a                }\u000a            })(config.Operations[i].Command\u002c msg\u002c opeA);\u000a        }\u000a\u000a        if (custom != undefined)\u000a        {\u000a            msgDiv.appendChild(custom);\u000a        }\u000a    }\u000a\u000a    if (temp == undefined) This.GetDocument().body.appendChild(msgDiv);\u000a    else This.GetDocument().body.replaceChild(msgDiv\u002c temp);\u000a\u000a    //msgDiv.scrollIntoView();\u000a    This.GetDocument().body.scrollTop = This.GetDocument().body.scrollHeight;\u000a    msgDiv = null;\u000a}\u000a\u000aThis.AddDom = function(dom)\u000a{\u000a    This.GetDocument().body.appendChild(dom);\u000a\u000a    This.GetDocument().body.scrollTop = This.GetDocument().body.scrollHeight;\u000a\u000a    msgDiv = null;\u000a}\u000a\u000aThis.Link(\u0022StyleSheet\u0022\u002c IMCore.GetUrl(\u0022Themes/Default/EditorCss.css\u0022)\u002c \u0022text/css\u0022);\u000a\u000aThis.GetDocument().onkeydown = function(e)\u000a{\u000a    var evt = new IMCore.Event(e\u002c This.GetWindow());\u000a    if (evt.GetEvent().keyCode == 116 || (evt.GetEvent().ctrlKey \u0026\u0026 evt.GetEvent().keyCode == 82))\u000a    {\u000a        evt.GetEvent().keyCode = 0;\u000a        evt.GetEvent().returnValue = false;\u000a        return false;\u000a    }\u000a    if (evt.GetEvent().keyCode == 70 \u0026\u0026 evt.GetEvent().ctrlKey \u0026\u0026 !evt.GetEvent().altKey \u0026\u0026 !evt.GetEvent().shiftKey)\u000a    {\u000a        evt.GetEvent().keyCode = 0;\u000a        evt.GetEvent().returnValue = false;\u000a        return false;\u000a    }\u000a}\u000a\u000afunction UploadHandler(file\u002c afterUpload)\u000a{\u000a    var html = String.format(\u0022\u003cdiv class=\u0027dl_image_dl\u0027\u003e\u003c/div\u003e\u003cdiv class=\u0027dl_text\u0027\u003e\u003cspan class=\u0027span_normal\u0027\u003e正在上传 \u005c\u0022{0}\u005c\u0022...\u003c/span\u003e\u003cspan class=\u0027processing\u0027\u003e\u003c/span\u003e\u003ca\u003e取消\u003c/a\u003e\u003c/div\u003e\u0022\u002c file\u002c Module.GetResourceUrl(\u0022WebIM/dl_file.gif\u0022));\u000a    var dom = This.GetDocument().createElement(\u0022DIV\u0022);\u000a    dom.className = \u0027message_file_dl\u0027;\u000a    dom.innerHTML = html;\u000a\u000a    var info_dom = dom.childNodes[1].childNodes[0];\u000a    var pdom = dom.childNodes[1].childNodes[1];\u000a    var a_dom = dom.childNodes[1].childNodes[2];\u000a    var img_dom = dom.childNodes[0];\u000a\u000a    var _isCanceled = false;\u000a    a_dom.onclick = function()\u000a    {\u000a        _isCanceled = true;\u000a    }\u000a\u000a    var _recv = 0\u002c\u000a    _total = 0;\u000a\u000a    this.BeforeUpload = function()\u000a    {\u000a        This.AddDom(dom);\u000a    }\u000a\u000a    this.Processing = function(length\u002c size\u002c speed)\u000a    {\u000a        _recv = length;\u000a        _total = size;\u000a        var temp;\u000a        if (size \u003e 1024 * 1024 * 1024) temp = Math.round(size / (1024 * 1024 * 1024) * 100) / 100 + \u0022GB\u0022;\u000a        else if (size \u003e 1024 * 1024) temp = Math.round(size / (1024 * 1024) * 100) / 100 + \u0022MB\u0022;\u000a        else if (size \u003e 1024) temp = Math.round(size / 1024 * 100) / 100 + \u0022KB\u0022;\u000a        else temp = size + \u0022B\u0022;\u000a        pdom.innerHTML = String.format(\u0022上传速度:{2}KB/s 已完成:{0}%\u002c 共 {1}\u0022\u002c (Math.round(length / size * 1000) / 10)\u002c temp\u002c Math.round(speed / 10) / 100);\u000a        return _isCanceled ? 0 : 1;\u000a    }\u000a\u000a    this.AfterUpload = function(path)\u000a    {\u000a        info_dom.innerHTML = String.format(_recv == _total ? \u0022\u005c\u0022{0}\u005c\u0022 上传完毕\u0022: \u0022\u005c\u0022{0}\u005c\u0022 上传已取消！\u0022\u002c file);\u000a        info_dom.className = (_recv == _total ? \u0022span_normal\u0022: \u0022span_red\u0022);\u000a        pdom.innerHTML = \u0022\u0022;\u000a        a_dom.style.display = \u0027none\u0027;\u000a        img_dom.className = (_recv == _total ? \u0022dl_image_file\u0022: \u0022dl_image_cancel\u0022);\u000a        if (afterUpload != undefined) afterUpload(path);\u000a    }\u000a\u000a    this.HandleError = function(msg)\u000a    {\u000a        info_dom.className = \u0022span_red\u0022;\u000a        info_dom.innerHTML = String.format(\u0022上传 \u005c\u0022{0}\u005c\u0022 时发生错误: {1}\u0022\u002c file\u002c msg);\u000a        pdom.innerHTML = \u0022\u0022;\u000a        a_dom.style.display = \u0027none\u0027;\u000a        img_dom.className = \u0022dl_image_error\u0022;\u000a    }\u000a}\u000a\u000aThis.UploadFile = function(file\u002c afterUpload)\u000a{\u000a    if (ClientMode)\u000a    {\u000a        var handler = new UploadHandler(IMCore.Path.GetFileName(file)\u002c afterUpload);\u000a        window.external.Upload(document.cookie\u002c file\u002c handler);\u000a    }\u000a}\u000a\u000afunction DownloadHandler(file)\u000a{\u000a    var html = String.format(\u0022\u003cdiv class=\u0027dl_image_dl\u0027\u003e\u003c/div\u003e\u003cdiv class=\u0027dl_text\u0027\u003e\u003cspan class=\u0027span_normal\u0027\u003e正在下载 \u005c\u0022{0}\u005c\u0022...\u003c/span\u003e\u003cspan class=\u0027processing\u0027\u003e\u003c/span\u003e\u003ca\u003e取消\u003c/a\u003e\u003c/div\u003e\u0022\u002c file\u002c Module.GetResourceUrl(\u0022WebIM/dl_file.gif\u0022));\u000a    var dom = This.GetDocument().createElement(\u0022DIV\u0022);\u000a    dom.className = \u0027message_file_dl\u0027;\u000a    dom.innerHTML = html;\u000a\u000a    var info_dom = dom.childNodes[1].childNodes[0];\u000a    var pdom = dom.childNodes[1].childNodes[1];\u000a    var a_dom = dom.childNodes[1].childNodes[2];\u000a    var img_dom = dom.childNodes[0];\u000a\u000a    var _isCanceled = false;\u000a    a_dom.onclick = function()\u000a    {\u000a        _isCanceled = true;\u000a    }\u000a\u000a    var _recv = 0\u002c\u000a    _total = 0;\u000a\u000a    this.BeforeDownload = function()\u000a    {\u000a        This.AddDom(dom);\u000a    }\u000a\u000a    this.Processing = function(length\u002c size\u002c speed)\u000a    {\u000a        _recv = length;\u000a        _total = size;\u000a        var temp;\u000a        if (size \u003e 1024 * 1024 * 1024) temp = Math.round(size / (1024 * 1024 * 1024) * 100) / 100 + \u0022GB\u0022;\u000a        else if (size \u003e 1024 * 1024) temp = Math.round(size / (1024 * 1024) * 100) / 100 + \u0022MB\u0022;\u000a        else if (size \u003e 1024) temp = Math.round(size / 1024 * 100) / 100 + \u0022KB\u0022;\u000a        else temp = size + \u0022B\u0022;\u000a        pdom.innerHTML = String.format(\u0022下载速度:{2}KB/s 已完成:{0}%\u002c 共 {1}\u0022\u002c (Math.round(length / size * 1000) / 10)\u002c temp\u002c Math.round(speed / 10) / 100);\u000a        return _isCanceled ? 0 : 1;\u000a    }\u000a\u000a    this.AfterDownload = function()\u000a    {\u000a        info_dom.innerHTML = String.format(_recv == _total ? \u0022\u005c\u0022{0}\u005c\u0022 下载完毕\u0022: \u0022\u005c\u0022{0}\u005c\u0022 下载已取消！\u0022\u002c file);\u000a        info_dom.className = (_recv == _total ? \u0022span_normal\u0022: \u0022span_red\u0022);\u000a        pdom.innerHTML = \u0022\u0022;\u000a        a_dom.style.display = \u0027none\u0027;\u000a        img_dom.className = (_recv == _total ? \u0022dl_image_file\u0022: \u0022dl_image_cancel\u0022);\u000a    }\u000a\u000a    this.HandleError = function(msg)\u000a    {\u000a        info_dom.className = \u0022span_red\u0022;\u000a        info_dom.innerHTML = String.format(\u0022下载 \u005c\u0022{0}\u005c\u0022 时发生错误: {1}\u0022\u002c file\u002c msg);\u000a        pdom.innerHTML = \u0022\u0022;\u000a        a_dom.style.display = \u0027none\u0027;\u000a        img_dom.className = \u0022dl_image_error\u0022;\u000a    }\u000a}\u000a\u000aThis.GetWindow().OpenLink = function(filePath)\u000a{\u000a    return confirm(String.format(\u0022您确定要打开\u005c\u0022{0}\u005c\u0022？\u0022\u002c filePath));\u000a}\u000a\u000aThis.GetWindow().SaveFile = function(filePath)\u000a{\u000a    if (ClientMode)\u000a    {\u000a        window.external.Save(document.cookie\u002c IMCore.GetPageUrl(\u0022download.aspx\u0022) + \u0022?FileName=\u0022 + filePath\u002c IMCore.Path.GetFileName(filePath)\u002c new DownloadHandler(IMCore.Path.GetFileName(filePath)));\u000a    }\u000a}\u000aThis.GetWindow().OpenFile = function(filePath)\u000a{\u000a    if (ClientMode)\u000a    {\u000a        window.external.Open(document.cookie\u002c IMCore.GetPageUrl(\u0022download.aspx\u0022) + \u0022?FileName=\u0022 + filePath\u002c IMCore.Path.GetFileName(filePath)\u002c new DownloadHandler(IMCore.Path.GetFileName(filePath)));\u000a    }\u000a}","CustomConfig":"if (config.BorderWidth == undefined) config.BorderWidth = 1;\u000aconfig.Css = \u0022MsgPanel\u0022;\u000a\u000avar m_User = config.User;\u000avar m_Peer = config.Peer;","BaseName":"Controls.Frame","GlobalCode":"","Count":0,"Left":108,"Top":51,"Width":200,"Height":200,"Name":"MsgPanel","Text":"CustomControl1","AnchorStyle":3}},{"Constructor":"CustomControlDesignPH","Config":{"Controls":[],"MemberCode":"This.CreateFileHtml = function(paths)\u000a{\u000a    var fs = [];\u000a    for (var i in paths)\u000a    {\u000a        var html = \u0022\u003cdiv contenteditable=\u0027false\u0027 class=\u0027message_file\u0027\u003e\u0022 + String.format(\u0022[FILE:{0}]\u0022\u002c paths[i]) + \u0022\u003c/div\u003e\u0022;\u000a        fs.push(html);\u000a    }\u000a    return \u0022\u003cbr/\u003e\u0022 + fs.join(\u0022\u003cbr/\u003e\u0022) + \u0022\u003cbr/\u003e\u0022;\u000a}","CustomConfig":"config.StyleSheet = IMCore.GetUrl(\u0022Themes/Default/EditorCss.css\u0022);","BaseName":"RichEditor","GlobalCode":"","Count":0,"Left":0,"Top":0,"Width":200,"Height":200,"Name":"MsgEditor","Text":"CustomControl1","AnchorStyle":3}},{"Constructor":"CustomControlDesignPH","Config":{"Controls":[{"Constructor":"CustomControlObjectPH","Config":{"_Css":"control","ConfigCode":"m_FriendPanel_Config.BorderWidth = 1;","InitCode":"","ClassName":"FriendPanel","Count":0,"Left":6,"Top":26,"Width":200,"Height":418,"Name":"m_FriendPanel","Text":"","AnchorStyle":11}},{"Constructor":"CustomControlObjectPH","Config":{"_Css":"control","ConfigCode":"","InitCode":"","ClassName":"MsgPanel","Count":0,"Left":211,"Top":26,"Width":398,"Height":418,"Name":"m_MsgPanel","Text":"","AnchorStyle":15}},{"Constructor":"ToolbarPH","Config":{"_Css":"toolbar","OnCommandCode":"if (command == \u0022Previous\u0022)\u000a{\u000a    if (m_Messages.length \u003e 0)\u000a    {\u000a        m_From = new Date(2000\u002c 0\u002c 1);\u000a        m_To = m_Messages[m_Messages.length - 1].CreatedTime;\u000a    }\u000a    RefreshMessages();\u000a}\u000aelse if (command == \u0022Next\u0022)\u000a{\u000a    if (m_Messages.length \u003e 0)\u000a    {\u000a        m_To = new Date(2100\u002c 0\u002c 1);\u000a        m_From = m_Messages[0].CreatedTime;\u000a    }\u000a    RefreshMessages();\u000a}","InitCode":"","Controls":[],"_Items":[{"Text":"上一页","Css":"Image22_UpButton","Command":"Previous"},{"Text":"下一页","Css":"Image22_DownButton","Command":"Next"}],"Count":0,"Left":6,"Top":1,"Width":603,"Height":24,"Name":"toolbar3","Text":"","AnchorStyle":7}}],"MemberCode":"m_FriendPanel.Refresh(function()\u000a{\u000a    m_FriendPanel.Expand(EmptyCallback\u002c \u0022/Users\u0022);\u000a    m_FriendPanel.Expand(EmptyCallback\u002c \u0022/Groups\u0022);\u000a});\u000a\u000avar m_Peer = IMCore.Utility.IsNull(IMCore.Params[\u0022Peer\u0022]\u002c \u0022\u0022);\u000a\u000avar m_To = new Date(2100\u002c 0\u002c 1);\u000avar m_From = new Date(2000\u002c 0\u002c 1);\u000a\u000avar m_Messages = [];\u000a\u000afunction RefreshMessages()\u000a{\u000a    if (m_Peer == \u0022\u0022) return;\u000a    var data = {\u000a        Action: \u0022FindHistory\u0022\u002c\u000a        User: IMCore.Session.GetUserName()\u002c\u000a        Peer: m_Peer\u002c\u000a        From: m_From\u002c\u000a        To: m_To\u000a    };\u000a    IMCore.SendCommand(\u000a    function(ret)\u000a    {\u000a        m_FriendPanel.Select(EmptyCallback\u002c (IMCore.Params[\u0022Type\u0022] == \u00220\u0022 ? \u0022/Users/\u0022: \u0022/Groups/\u0022) + m_Peer.toUpperCase());\u000a        m_MsgPanel.Clear();\u000a        for (var i = ret.Messages.length - 1; i \u003e= 0; i--)\u000a        {\u000a            m_MsgPanel.AddMessage(ret.Messages[i]);\u000a        }\u000a        m_Messages = ret.Messages;\u000a    }\u002c\u000a    function(ex)\u000a    {\u000a        IMCore.Utility.ShowError(ex.toString());\u000a    }\u002c\u000a    IMCore.Utility.RenderJson(data)\u002c \u0022Core.Web Common_CH\u0022\u002c false);\u000a}\u000a\u000am_FriendPanel.OnClick.Attach(\u000afunction()\u000a{\u000a    m_To = new Date(2100\u002c 0\u002c 1);\u000a    m_From = new Date(2000\u002c 0\u002c 1);\u000a    var node = m_FriendPanel.GetSelectedNode();\u000a    if (node != null \u0026\u0026 node.GetTag() != null)\u000a    {\u000a        m_Peer = node.GetTag().Name;\u000a        RefreshMessages();\u000a    }\u000a});\u000a\u000aControls.CreateVerticalSplit(m_FriendPanel\u002c m_MsgPanel);\u000a\u000aRefreshMessages();","CustomConfig":"","BaseName":"Control","GlobalCode":"Module.MsgHistroyPanel = MsgHistroyPanel;","Count":3,"Left":12,"Top":34,"Width":615,"Height":449,"Name":"MsgHistroyPanel","Text":"CustomControl1","AnchorStyle":3}},{"Constructor":"CustomControlDesignPH","Config":{"Controls":[],"MemberCode":"","CustomConfig":"","BaseName":"Management.FriendPanel","GlobalCode":"","Count":0,"Left":38,"Top":27,"Width":200,"Height":200,"Name":"FriendPanel","Text":"CustomControl1","AnchorStyle":3}},{"Constructor":"CustomControlDesignPH","Config":{"Controls":[{"Constructor":"SimpleTabControlPH","Config":{"_Css":"simple_tab_gred","_BorderWidth":1,"OnSelectedTabCode":"","InitCode":"","Tabs":[{"Text":"聊天窗口","Width":80,"ID":"ID100000007","IsSelected":true}],"DesignPHBs":[{"Constructor":"SimplePlaceHolder","Config":{"Controls":[{"Constructor":"CustomControlObjectPH","Config":{"_Css":"control","ConfigCode":"m_ChatPanel_Config.User = config.User\u000am_ChatPanel_Config.Peer = config.Peer;","InitCode":"","ClassName":"ChatPanel","Count":0,"Left":8,"Top":5,"Width":444,"Height":459,"Name":"m_ChatPanel","Text":"","AnchorStyle":15}}],"Count":0,"Left":0,"Top":0,"Width":461,"Height":471,"Name":"tab1.GetPanel(0)","Text":"","AnchorStyle":15}}],"Count":0,"Left":1,"Top":1,"Width":463,"Height":498,"Name":"tab1","Text":"","AnchorStyle":15}},{"Constructor":"CustomControlObjectPH","Config":{"_Css":"control","ConfigCode":"m_GroupMemberList_Config.BorderWidth = 1;\u000am_GroupMemberList_Config.Group = config.Peer;","InitCode":"","ClassName":"GroupMemberList","Count":0,"Left":469,"Top":1,"Width":180,"Height":498,"Name":"m_GroupMemberList","Text":"","AnchorStyle":14}}],"MemberCode":"This.AddMessage = m_ChatPanel.AddMessage;\u000a\u000aCurrentWindow.OnNotify.Attach(\u000afunction(command\u002c data)\u000a{\u000a    if (command == \u0022UserStateChanged\u0022)\u000a    {\u000a        m_GroupMemberList.RefreshMemberState(data.User\u002c data.State);\u000a    }\u000a});","CustomConfig":"","BaseName":"Control","GlobalCode":"Module.GroupChatForm = GroupChatForm;","Count":4,"Left":9,"Top":7,"Width":650,"Height":500,"Name":"GroupChatForm","Text":"CustomControl1","AnchorStyle":3}},{"Constructor":"CustomControlDesignPH","Config":{"Controls":[{"Constructor":"TreeViewPH","Config":{"_Css":"treeview","OnClickCode":"","InitCode":"","DSMemberCode":"var _members = null;\u000avar _groupInfo = null;\u000avar _groupCreator = null;\u000a\u000afunction _GetSubNodes(callback\u002c item)\u000a{\u000a    var nodes = [];\u000a    if (item.GetFullPath() == \u0022/Managers\u0022)\u000a    {\u000a        for (var i in _members)\u000a        {\u000a            var member = _members[i];\u000a            if (member.ID == _groupCreator.ID)\u000a            {\u000a                var node = {\u000a                    Name: member.Name.toUpperCase()\u002c\u000a                    Text: member.Nickname\u002c\u000a                    Tag: member\u002c\u000a                    HasChildren: false\u002c\u000a                    ImageSrc: GetHeadIMG(member\u002c 16\u002c member.State == \u0022Offline\u0022)\u000a                };\u000a                nodes.push(node);\u000a            }\u000a        }\u000a    }\u000a    else if (item.GetFullPath() == \u0022/Members\u0022)\u000a    {\u000a        for (var i in _members)\u000a        {\u000a            var member = _members[i];\u000a            if (member.ID != _groupCreator.ID)\u000a            {\u000a                var node = {\u000a                    Name: member.Name.toUpperCase()\u002c\u000a                    Text: member.Nickname\u002c\u000a                    Tag: member\u002c\u000a                    HasChildren: false\u002c\u000a                    ImageSrc: GetHeadIMG(member\u002c 16\u002c member.State == \u0022Offline\u0022)\u000a                };\u000a                nodes.push(node);\u000a            }\u000a        }\u000a    }\u000a    callback(nodes);\u000a}","DSGetSubNodesCode":"if (item == null)\u000a{\u000a    var nodes = [{\u000a        Name: \u0022Managers\u0022\u002c\u000a        Text: \u0022群管理员\u0022\u002c\u000a        Tag: null\u002c\u000a        ImageCss: \u0022Image16_Group\u0022\u000a    }\u002c\u000a    {\u000a        Name: \u0022Members\u0022\u002c\u000a        Text: \u0022群组成员\u0022\u002c\u000a        Tag: null\u002c\u000a        ImageCss: \u0022Image16_Group\u0022\u000a    }];\u000a    callback(nodes);\u000a}\u000aelse\u000a{\u000a    if (_members == null)\u000a    {\u000a        var data = {\u000a            Action: \u0022GetGroupMembers\u0022\u002c\u000a            Name: config.Group.Name\u000a        };\u000a        IMCore.SendCommand(\u000a        function(ret)\u000a        {\u000a            _members = ret.Members;\u000a            _gourpInfo = ret.GroupInfo;\u000a            _groupCreator = ret.GroupCreator;\u000a            _GetSubNodes(callback\u002c item);\u000a        }\u002c\u000a        function(ex)\u000a        {\u000a            callback(null\u002c ex);\u000a        }\u002c\u000a        IMCore.Utility.RenderJson(data)\u002c \u0022Core.Web Common_CH\u0022\u002c false);\u000a    }\u000a    else\u000a    {\u000a        _GetSubNodes(callback\u002c item);\u000a    }\u000a}","_BorderWidth":0,"Count":0,"Left":1,"Top":22,"Width":220,"Height":533,"Name":"m_GroupMemberTreeView","Text":"","AnchorStyle":15}},{"Constructor":"CustomControlObjectPH","Config":{"_Css":"control","ConfigCode":"m_Header_Config.Text = \u0022群成员列表\u0022;","InitCode":"","ClassName":"HeaderCtrl","Count":0,"Left":0,"Top":0,"Width":222,"Height":21,"Name":"m_Header","Text":"","AnchorStyle":7}}],"MemberCode":"m_GroupMemberTreeView.Refresh(function()\u000a{\u000a    m_GroupMemberTreeView.Expand(EmptyCallback\u002c \u0022/Managers\u0022);\u000a    m_GroupMemberTreeView.Expand(EmptyCallback\u002c \u0022/Members\u0022);\u000a});\u000a\u000am_GroupMemberTreeView.OnDblClick.Attach(\u000afunction()\u000a{\u000a    if (m_GroupMemberTreeView.GetSelectedNode().GetTag() != null \u0026\u0026 m_GroupMemberTreeView.GetSelectedNode().GetTag().ID != IMCore.Session.GetUserInfo().ID)\u000a    {\u000a        var form = IMCore.Session.GetGlobal(\u0022ChatService\u0022).Open(m_GroupMemberTreeView.GetSelectedNode().GetTag().Name\u002c false);\u000a    }\u000a});\u000a\u000aThis.RefreshMemberState = function(memberId\u002c state)\u000a{\u000a    m_GroupMemberTreeView.GetAllNodes(function(node)\u000a    {\u000a        if (node.GetTag() != null \u0026\u0026 node.GetTag().ID == memberId)\u000a        {\u000a            node.SetImage(GetHeadIMG(node.GetTag()\u002c 16\u002c state == \u0022Offline\u0022))\u000a        }\u000a    });\u000a}","CustomConfig":"config.Css = \u0022GroupMemberList\u0022;","BaseName":"Control","GlobalCode":"","Count":2,"Left":12,"Top":10,"Width":222,"Height":556,"Name":"GroupMemberList","Text":"CustomControl1","AnchorStyle":3}},{"Constructor":"CustomControlDesignPH","Config":{"Controls":[{"Constructor":"SimpleTabControlPH","Config":{"_Css":"simple_tab_gred","_BorderWidth":1,"OnSelectedTabCode":"if (index == 1)\u000a{\u000a    var data = {\u000a        Action: \u0022FindHistory\u0022\u002c\u000a        User: IMCore.Session.GetUserInfo().Name\u002c\u000a        Peer: config.Peer.Name\u002c\u000a        From: new Date(2000\u002c 0\u002c 1)\u002c\u000a        To: new Date(2100\u002c 0\u002c 1)\u002c\u000a        All: true\u000a    };\u000a\u000a    CurrentWindow.Waiting(\u0022正在载入消息记录...\u0022);\u000a    IMCore.SendCommand(\u000a    function(ret)\u000a    {\u000a        CurrentWindow.Completed();\u000a\u000a        m_MsgPanel.Clear();\u000a        for (var i = ret.Messages.length - 1; i \u003e= 0; i--)\u000a        {\u000a            m_MsgPanel.AddMessage(ret.Messages[i]);\u000a        }\u000a    }\u002c\u000a    function(ex)\u000a    {\u000a        CurrentWindow.Completed();\u000a        IMCore.Utility.ShowError(ex.toString());\u000a    }\u002c\u000a    IMCore.Utility.RenderJson(data)\u002c \u0022Core.Web Common_CH\u0022\u002c false);\u000a}","InitCode":"tab1.SetTabVisible(1\u002c config.User.IsTemp || config.Peer.IsTemp);","Tabs":[{"Text":"会话窗口","Width":80,"ID":"ID100000010","IsSelected":true},{"Text":"聊天记录","Width":80,"ID":"ID100000012","IsSelected":false}],"DesignPHBs":[{"Constructor":"SimplePlaceHolder","Config":{"Controls":[{"Constructor":"CustomControlObjectPH","Config":{"_Css":"control","ConfigCode":"m_ChatPanel_Config.User = config.User\u000am_ChatPanel_Config.Peer = config.Peer;","InitCode":"","ClassName":"ChatPanel","Count":0,"Left":8,"Top":5,"Width":444,"Height":459,"Name":"m_ChatPanel","Text":"","AnchorStyle":15}}],"Count":0,"Left":0,"Top":0,"Width":461,"Height":471,"Name":"tab1.GetPanel(0)","Text":"","AnchorStyle":15}},{"Constructor":"SimplePlaceHolder","Config":{"Controls":[{"Constructor":"CustomControlObjectPH","Config":{"_Css":"control","ConfigCode":"","InitCode":"","ClassName":"MsgPanel","Count":0,"Left":8,"Top":30,"Width":444,"Height":434,"Name":"m_MsgPanel","Text":"","AnchorStyle":15}},{"Constructor":"ToolbarPH","Config":{"_Css":"toolbar","OnCommandCode":"if (command == \u0022SaveAs\u0022)\u000a{\u000a    var url = String.format(\u0022DownloadMsg.ashx?Peer={0}\u0026random={1}\u0022\u002c config.Peer.ID\u002c (new Date()).getTime());\u000a    m_MsgPanel.Navigate(IMCore.GetPageUrl(url));\u000a}","InitCode":"","Controls":[],"_Items":[{"Text":"保存聊天记录","Css":"Image22_SaveAs","Command":"SaveAs"}],"Count":0,"Left":8,"Top":5,"Width":443,"Height":24,"Name":"toolbar7","Text":"","AnchorStyle":7}}],"Count":0,"Left":0,"Top":0,"Width":461,"Height":471,"Name":"tab1.GetPanel(1)","Text":"","AnchorStyle":15}}],"Count":0,"Left":1,"Top":1,"Width":463,"Height":498,"Name":"tab1","Text":"","AnchorStyle":15}},{"Constructor":"CustomControlObjectPH","Config":{"_Css":"control","ConfigCode":"m_UserImageCtrl_Config.BorderWidth = 1;","InitCode":"m_UserImageCtrl.LoadImage(GetHeadIMG(config.User\u002c 150\u002c config.User.State == \u0022Offline\u0022));","ClassName":"UserImageCtrl","Count":0,"Left":469,"Top":319,"Width":180,"Height":180,"Name":"m_UserImageCtrl","Text":"","AnchorStyle":12}},{"Constructor":"CustomControlObjectPH","Config":{"_Css":"control","ConfigCode":"m_UserInfoCtrl_Config.BorderWidth = 1;\u000am_UserInfoCtrl_Config.User = config.Peer;","InitCode":"","ClassName":"UserInfoCtrl","Count":0,"Left":469,"Top":1,"Width":180,"Height":314,"Name":"m_UserInfoCtrl","Text":"","AnchorStyle":14}}],"MemberCode":"This.AddMessage = m_ChatPanel.AddMessage;\u000a\u000aCurrentWindow.OnNotify.Attach(\u000afunction(command\u002c data)\u000a{\u000a    if (command == \u0022FriendInfoChanged\u0022)\u000a    {\u000a        /*m_FriendPanel.Refresh(function()\u000a        {\u000a            m_FriendPanel.Expand(EmptyCallback\u002c \u0022/Users\u0022);\u000a            m_FriendPanel.Expand(EmptyCallback\u002c \u0022/Groups\u0022);\u000a        });*/\u000a    }\u000a    else if (command == \u0022UserInfoChanged\u0022)\u000a    {\u000a        var userInfo = IMCore.Session.GetUserInfo();\u000a        m_UserImageCtrl.LoadImage(GetHeadIMG(userInfo\u002c 150\u002c false));\u000a    }\u000a    else if (command == \u0022UserStateChanged\u0022)\u000a    {\u000a        if (config.Peer.ID == data.User)\u000a        {\u000a            m_UserInfoCtrl.ResetUserInfo(data.Details);\u000a        }\u000a    }\u000a});","CustomConfig":"","BaseName":"Control","GlobalCode":"Module.UserChatForm = UserChatForm;","Count":7,"Left":24,"Top":10,"Width":650,"Height":500,"Name":"UserChatForm","Text":"CustomControl1","AnchorStyle":3}},{"Constructor":"CustomControlDesignPH","Config":{"Controls":[],"MemberCode":"","CustomConfig":"config.Css = \u0027UserImageCtrl\u0027;","BaseName":"Management.ImageControl","GlobalCode":"","Count":0,"Left":23,"Top":13,"Width":165,"Height":181,"Name":"UserImageCtrl","Text":"CustomControl1","AnchorStyle":3}},{"Constructor":"CustomControlDesignPH","Config":{"Controls":[{"Constructor":"CustomControlObjectPH","Config":{"_Css":"control","ConfigCode":"m_ImageCtrl_Config.BorderWidth = 0;","InitCode":"m_ImageCtrl.LoadImage(GetHeadIMG(config.User\u002c 150\u002c config.User.State == \u0022Offline\u0022));","ClassName":"UserImageCtrl","Count":0,"Left":0,"Top":0,"Width":200,"Height":180,"Name":"m_ImageCtrl","Text":"","AnchorStyle":7}}],"MemberCode":"This.ResetUserInfo = function(info)\u000a{\u000a    config.User = info;\u000a    m_ImageCtrl.LoadImage(GetHeadIMG(config.User\u002c 150\u002c config.User.State == \u0022Offline\u0022));\u000a}","CustomConfig":"config.Css = \u0027UserInfoCtrl\u0027;","BaseName":"Control","GlobalCode":"","Count":1,"Left":76,"Top":33,"Width":200,"Height":486,"Name":"UserInfoCtrl","Text":"CustomControl1","AnchorStyle":3}},{"Constructor":"CustomControlDesignPH","Config":{"Controls":[],"MemberCode":"This.GetDom().innerHTML = String.format(\u0022\u003cdiv class=\u0027HeaderCtrl\u0027\u003e\u003cdiv class=\u0027HeaderCtrlText\u0027\u003e{0}\u003c/div\u003e\u003c/div\u003e\u0022\u002c config.Text);","CustomConfig":"","BaseName":"Control","GlobalCode":"","Count":0,"Left":43,"Top":62,"Width":146,"Height":21,"Name":"HeaderCtrl","Text":"CustomControl1","AnchorStyle":3}}],"InitCode":"IMCore.LoadModules(function()\u000a{\u000a    RichEditor = IMCore.GetModule(\u0022RichEditor.js\u0022).RichEditor;\u000a    Management = IMCore.GetModule(\u0022Management.js\u0022);\u000a\u000a    completeCallback();\u000a}\u002c\u000aerrorCallback\u002c [\u0022RichEditor.js\u0022\u002c \u0022Management.js\u0022]);","DisposeCode":"completeCallback();","ModuleGlobalCode":"var RichEditor = null;\u000avar Management = null;\u000a\u000afunction EmptyCallback()\u000a{\u000a\u000a}\u000a\u000avar MessageFormat =\u000a\u000a\u0022\u003cdiv class=\u0027messageTitle\u0027\u003e\u0022 +\u000a\u000a\u0022\u003cspan class=\u0027sender\u0027\u003e{0}\u003c/span\u003e\u0022 +\u000a\u000a\u0022\u003cspan class=\u0027time\u0027\u003e{1}\u003c/span\u003e\u0022 +\u000a\u000a\u0022\u003cspan class=\u0027operationContainer\u0027\u003e\u003c/span\u003e\u0022 +\u000a\u000a\u0022\u003c/div\u003e\u0022 +\u000a\u000a\u0022\u003cdiv class=\u0027messageContent\u0027\u003e{2}\u003c/div\u003e\u0022;\u000a\u000avar MessageFormatDom =\u000a\u000a\u0022\u003cdiv class=\u0027messageTitle\u0027\u003e\u0022 +\u000a\u000a\u0022\u003c/div\u003e\u0022 +\u000a\u000a\u0022\u003cdiv class=\u0027messageContent\u0027\u003e\u003c/div\u003e\u0022 +\u000a\u000a\u0022\u003cbr/\u003e\u0022;\u000a\u000avar MSF_MessageFormat =\u000a\u000a\u0022\u003cdiv class=\u0027messageTitle\u0027\u003e\u0022 +\u000a\u000a\u0022\u003cspan class=\u0027sender\u0027\u003e{0}\u003c/span\u003e\u0022 +\u000a\u000a\u0022\u003cspan class=\u0027time\u0027\u003e{1}\u003c/span\u003e\u0022 +\u000a\u000a\u0022\u003c/div\u003e\u0022 +\u000a\u000a\u0022\u003cdiv class=\u0027messageContent\u0027\u003e{2}\u003c/div\u003e\u0022 +\u000a\u000a\u0022\u003cbr/\u003e\u0022;\u000a\u000avar MSF_MessageFormatDom =\u000a\u000a\u0022\u003cdiv class=\u0027messageTitle\u0027\u003e\u0022 +\u000a\u000a\u0022\u003c/div\u003e\u0022 +\u000a\u000a\u0022\u003cdiv class=\u0027messageContent\u0027\u003e\u003c/div\u003e\u0022 +\u000a\u000a\u0022\u003cbr/\u003e\u0022;\u000a\u000avar FileHtmlFormat = \u0022\u0022;\u000a\u000aif (!ClientMode)\u000a{\u000a    FileHtmlFormat = \u0022\u003cdiv class=\u0027div_filename\u0027\u003e文件名:{0}\u003c/div\u003e\u0022 +\u000a\u000a    \u0022\u003cdiv class=\u0027operationContainer\u0027\u003e\u0022 +\u000a\u000a    \u0022\u003cdiv class=\u0027link_download\u0027\u003e\u003ca target=\u0027_blank\u0027 href=\u0027\u0022 + IMCore.GetPageUrl(\u0022download.aspx\u0022) + \u0022?FileName={1}\u0027\u003e下载\u003c/a\u003e\u003c/div\u003e\u0022 +\u000a\u000a    //\u0022\u003cdiv class=\u0027link_saveas\u0027\u003e\u003cspan onclick=\u0027javascript:window.SaveFile(unescape(\u005c\u0022{1}\u005c\u0022))\u0027\u003e另存为\u003c/span\u003e\u003c/div\u003e\u0022 +\u000a    \u0022\u003c/div\u003e\u0022;\u000a}\u000aelse\u000a{\u000a    FileHtmlFormat = \u0022\u003cdiv class=\u0027div_filename\u0027\u003e文件名:{0}\u003c/div\u003e\u0022 +\u000a\u000a    \u0022\u003cdiv class=\u0027operationContainer\u0027\u003e\u0022 +\u000a\u000a    \u0022\u003cdiv class=\u0027link_saveas\u0027\u003e\u003cspan onclick=\u0027javascript:window.OpenFile(unescape(\u005c\u0022{1}\u005c\u0022))\u0027\u003e打开\u003c/span\u003e\u003c/div\u003e\u0022 +\u000a\u000a    \u0022\u003cdiv class=\u0027link_saveas\u0027\u003e\u003cspan onclick=\u0027javascript:window.SaveFile(unescape(\u005c\u0022{1}\u005c\u0022))\u0027\u003e另存为\u003c/span\u003e\u003c/div\u003e\u0022 +\u000a\u000a    \u0022\u003c/div\u003e\u0022;\u000a}\u000a\u000a//格式化数字\u000afunction FormatNumber(num\u002c length)\u000a{\u000a    var s = num.toString();\u000a    var zero = \u0022\u0022;\u000a    for (var i = 0; i \u003c length - s.length; i++) zero += \u00220\u0022;\u000a    return zero + s;\u000a}\u000a\u000a//时间转字符串\u000afunction DateToString(date)\u000a{\u000a    return String.format(\u0022{0}-{1}-{2} {3}:{4}:{5}\u0022\u002c FormatNumber(date.getFullYear()\u002c 4)\u002c FormatNumber(date.getMonth() + 1\u002c 2)\u002c FormatNumber(date.getDate()\u002c 2)\u002c FormatNumber(date.getHours()\u002c 2)\u002c FormatNumber(date.getMinutes()\u002c 2)\u002c FormatNumber(date.getSeconds()\u002c 2));\u000a}\u000a\u000a//消息处理\u000afunction TranslateMessage(msg\u002c data)\u000a{\u000a    msg = msg.replace(/\u003cimg [^\u005ct\u005cn\u005cr\u005cf\u005cv\u003c\u003e]+\u003e/ig\u002c\u000a    function(img)\u000a    {\u000a        return img.replace(/src[^\u003c\u003e]*=[^\u003c\u003e]*(\u005cx22|\u005cx27)([^\u003c\u003e]+\u005c/|)download.aspx\u005cx3FFileName=([^\u005ct\u005cn\u005cr\u005cf\u005cv\u005cx22]+)(\u005cx22|\u005cx27)/ig\u002c\u000a        function(text\u002c v1\u002c v2\u002c src)\u000a        {\u000a            url = String.format(IMCore.GetPageUrl(\u0022download.aspx\u0022) + \u0022?FileName={{Accessory type=\u005c\u0022image\u005c\u0022 src=\u005c\u0022{0}\u005c\u0022}\u0022\u002c src);\u000a            return String.format(\u0022src=\u005c\u0022{0}\u005c\u0022\u0022\u002c url);\u000a        });\u000a    });\u000a\u000a    msg = msg.replace(/\u003cimg [^\u005ct\u005cn\u005cr\u005cf\u005cv\u003c\u003e]+\u003e/ig\u002c\u000a    function(img)\u000a    {\u000a        return img.replace(/src[^\u003c\u003e]*=[^\u003c\u003e]*\u005cx22([^\u003c\u003e]+\u005c/|)file\u005cx3A\u005c/\u005c/\u005c/([^\u005ct\u005cn\u005cr\u005cf\u005cv\u005cx22]+)\u005cx22/ig\u002c\u000a        function(text\u002c v1\u002c src)\u000a        {\u000a\u000a            var data_id = IMCore.GenerateUniqueId();\u000a            var base64 = window.external.ToBase64String(src);\u000a            data[data_id] = base64;\u000a            var index = src.lastIndexOf(\u0022\u005c\u005c\u0022);\u000a            if (index \u003c 0) index = -1;\u000a            url = String.format(IMCore.GetPageUrl(\u0022download.aspx\u0022) + \u0022?FileName={{Accessory type=\u005c\u0022image\u005c\u0022 src=\u005c\u0022{0}\u005c\u0022 data=\u005c\u0022{1}\u005c\u0022}\u0022\u002c src.substr(index + 1\u002c src.length - index - 1)\u002c data_id);\u000a            return String.format(\u0022src=\u005c\u0022{0}\u005c\u0022\u0022\u002c url);\u000a        });\u000a    });\u000a\u000a    msg = msg.replace(/\u003ca [^\u005ct\u005cn\u005cr\u005cf\u005cv\u003c\u003e]+[^\u005cx2F]\u003e/ig\u002c\u000a    function(a)\u000a    {\u000a        var hrefReg = /href=\u005cx22[^\u005ct\u005cn\u005cr\u005cf\u005cv\u005cx22]+\u005cx22/ig\u000a        hrefReg.lastIndex = 0;\u000a        var href = hrefReg.exec(a);\u000a        return String.format(\u0022[A:{0}]\u0022\u002c href != null \u0026\u0026 href.length \u003e 0 ? escape(href[0].substr(6\u002c href[0].length - 7)) : \u0022\u0022);\u000a    });\u000a\u000a    msg = msg.replace(/\u003c\u005cx2Fa\u003e/ig\u002c\u000a    function(a)\u000a    {\u000a        return \u0022[/A]\u0022;\u000a    });\u000a\u000a    msg = msg.replace(/\u005cx5BFILE\u005cx3A[^\u005cn\u005cf\u005cr\u005ct\u005cv]+\u005cx5D/g\u002c\u000a    function(file)\u000a    {\u000a        return String.format(\u0022[FILE:{{Accessory type=\u005c\u0022file\u005c\u0022 src=\u005c\u0022{0}\u005c\u0022}]\u0022\u002c escape(file.substr(6\u002c file.length - 7)));\u000a    });\u000a\u000a    msg = msg.replace(/\u005cx5BLOCAL\u005cx3Afile\u005cx3A\u005c/\u005c/\u005c/([^\u005cn\u005cf\u005cr\u005ct\u005cv]+)\u005cx5D/g\u002c\u000a    function(file\u002c path)\u000a    {\u000a        var data_id = IMCore.GenerateUniqueId();\u000a        var base64 = window.external.ToBase64String(path);\u000a        data[data_id] = base64;\u000a        var index = path.lastIndexOf(\u0022\u005c\u005c\u0022);\u000a        if (index \u003c 0) index = -1;\u000a        return String.format(\u0022[FILE:{{Accessory type=\u005c\u0022file\u005c\u0022 src=\u005c\u0022{0}\u005c\u0022 data=\u005c\u0022{1}\u005c\u0022}]\u0022\u002c path.substr(index + 1\u002c path.length - (index + 1))\u002c data_id);\u000a    });\u000a\u000a    msg = msg.replace(/\u003c!--[^\u005cn\u005cf\u005cr\u005ct\u005cv\u003c\u003e]*--\u003e/g\u002c\u000a    function()\u000a    {\u000a        return \u0022\u0022;\u000a    });\u000a\u000a    return msg;\u000a}\u000a\u000afunction IsEmpty(str)\u000a{\u000a    for (var i = 0; i \u003c str.length;)\u000a    {\u000a        var c = str.substr(i\u002c 1);\u000a        if (str.substr(i\u002c 6).toLowerCase() == \u0022\u0026nbsp;\u0022) i += 6;\u000a        else if (c == \u0027\u005cn\u0027 || c == \u0027\u005cr\u0027 || c == \u0027\u005cf\u0027 || c == \u0027\u005ct\u0027 || c == \u0027\u005cv\u0027 || c == \u0027 \u0027) i++;\u000a        else return false;\u000a    }\u000a    return true;\u000a}\u000a\u000afunction GetHeadIMG(info\u002c size\u002c gred)\u000a{\u000a    if (info.HeadIMG == \u0022\u0022)\u000a    {\u000a        var url = IMCore.Config.ServiceUrl + \u0022/images/HeadIMG/user\u0022\u000a        if (size \u003e 0) url += \u0022.\u0022 + size;\u000a        if (gred) url += \u0022.gred\u0022;\u000a        url += \u0022.png\u0022;\u000a        return url;\u000a    }\u000a    else\u000a    {\u000a        return String.format(\u0022{0}?user={1}\u0026size={2}\u0026gred={3}\u0026headimg={4}\u0022\u002c IMCore.GetPageUrl(\u0022headimg.aspx\u0022)\u002c info.Name\u002c size\u002c gred\u002c info.HeadIMG);\u000a    }\u000a}"},"Css":"","Version":"1.0"}